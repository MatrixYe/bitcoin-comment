---
title: 笔记：主要的class
date: 2025-12-28 09:17:22
updated: 2025-12-28 10:49:38
tags: []
---

## 1. COutPoint（交易输出引用类）

COutPoint 类用于引用某一笔交易的特定输出，是比特币 UTXO 模型的核心组成部分。

**成员变量：**
- `uint256 hash`: 被引用交易的哈希值
- `unsigned int n`: 该交易输出的索引位置

**方法签名：**
- `COutPoint()`: 默认构造函数
- `COutPoint(uint256 hashIn, unsigned int nIn)`: 带参数构造函数
- `void SetNull()`: 将引用设置为空状态
- `bool IsNull() const`: 检查引用是否为空
- `friend bool operator<(const COutPoint& a, const COutPoint& b)`: 小于运算符重载
- `friend bool operator==(const COutPoint& a, const COutPoint& b)`: 等于运算符重载
- `IMPLEMENT_SERIALIZE(…)`: 序列化/反序列化方法
- `string ToString() const`: 转换为字符串表示
- `void print() const`: 打印输出

## 2. CInPoint（内存中交易输入引用类）

CInPoint 类是对 COutPoint 的封装，增加了指向交易对象的指针，用于内存中快速访问。

**成员变量：**
- `CTransaction* ptx`: 指向交易对象的指针
- `unsigned int n`: 输出索引位置

**方法签名：**
- `CInPoint()`: 默认构造函数
- `CInPoint(CTransaction* ptxIn, unsigned int nIn)`: 带参数构造函数
- `void SetNull()`: 设置为空状态
- `bool IsNull() const`: 检查是否为空

## 3. CTxIn（交易输入类）

CTxIn 类表示一笔交易的输入，引用前一交易的输出并提供解锁脚本。

**成员变量：**
- `COutPoint prevout`: 引用的前序输出点
- `CScript scriptSig`: 解锁脚本（签名脚本）
- `unsigned int nSequence`: 序列号（用于时间锁和替换机制）

**方法签名：**
- `CTxIn()`: 默认构造函数
- `CTxIn(COutPoint prevoutIn, CScript scriptSigIn, unsigned int nSequenceIn)`: 带参数构造函数
- `CTxIn(uint256 hashPrevTx, unsigned int nOut, CScript scriptSigIn, unsigned int nSequenceIn)`: 通过哈希引用构造
- `IMPLEMENT_SERIALIZE(…)`: 序列化方法
- `bool IsFinal() const`: 检查输入是否最终确认
- `bool IsNull() const`: 检查输入是否为空
- `void SetNull()`: 设置为空状态
- `string ToString() const`: 转换为字符串
- `void print() const`: 打印输出

## 4. CTxOut（交易输出类）

CTxOut 类表示交易的输出，包含金额和锁定脚本（公钥脚本）。

**成员变量：**
- `int64 nValue`: 输出金额（以聪为单位）
- `CScript scriptPubKey`: 锁定脚本（公钥脚本）

**方法签名：**
- `CTxOut()`: 默认构造函数
- `CTxOut(int64 nValueIn, CScript scriptPubKeyIn)`: 带参数构造函数
- `IMPLEMENT_SERIALIZE(…)`: 序列化方法
- `bool IsNull() const`: 检查输出是否为空
- `void SetNull()`: 设置为空状态
- `bool IsMine() const`: 检查是否属于当前钱包
- `int64 GetCredit() const`: 获取信用金额
- `int64 GetDebit() const`: 获取支出金额
- `int64 GetChange() const`: 获取找零金额
- `string ToString() const`: 转换为字符串
- `void print() const`: 打印输出

## 5. CTransaction（交易类）

CTransaction 类是比特币交易的核心封装，包含多个输入和输出，提供完整的交易处理功能。

**成员变量：**
- `int nVersion`: 交易版本号
- `vector<CTxIn> vin`: 交易输入向量
- `vector<CTxOut> vout`: 交易输出向量
- `unsigned int nLockTime`: 锁定时间

**方法签名：**
- `CTransaction()`: 默认构造函数
- `IMPLEMENT_SERIALIZE(…)`: 序列化方法
- `void SetNull()`: 设置为空状态
- `bool IsNull() const`: 检查是否为空
- `uint256 GetHash() const`: 获取交易哈希
- `bool IsFinal(int nBlockHeight, int64 nBlockTime) const`: 检查是否最终确认
- `bool IsNewerThan(const CTransaction& old) const`: 比较交易新旧
- `bool IsCoinBase() const`: 检查是否为 coinbase 交易
- `int GetSigOpCount() const`: 获取签名操作数量
- `bool IsStandard() const`: 检查是否符合标准格式
- `bool IsMine() const`: 检查是否属于当前钱包
- `bool IsFromMe() const`: 检查是否由当前钱包发出
- `int64 GetDebit() const`: 获取支出金额
- `int64 GetCredit() const`: 获取信用金额
- `int64 GetChange() const`: 获取找零金额
- `int64 GetValueOut() const`: 获取总输出金额
- `int64 GetMinFee(unsigned int nBlockSize, bool fAllowFree) const`: 计算最低手续费
- `bool ReadFromDisk(CDiskTxPos pos, FILE** pfileRet)`: 从磁盘读取交易
- `friend bool operator==(const CTransaction& a, const CTransaction& b)`: 等于运算符
- `friend bool operator!=(const CTransaction& a, const CTransaction& b)`: 不等于运算符
- `string ToString() const`: 转换为字符串
- `void print() const`: 打印输出
- `bool ReadFromDisk(CTxDB& txdb, COutPoint prevout, CTxIndex& txindexRet)`: 从数据库读取
- `bool ReadFromDisk(CTxDB& txdb, COutPoint prevout)`: 从数据库读取
- `bool ReadFromDisk(COutPoint prevout)`: 从输出点读取
- `bool DisconnectInputs(CTxDB& txdb)`: 断开交易输入
- `bool ConnectInputs(CTxDB& txdb, map<uint256, CTxIndex>& mapTestPool, CDiskTxPos posThisTx, CBlockIndex* pindexBlock, int64& nFees, bool fBlock, bool fMiner, int64 nMinFee)`: 连接交易输入
- `bool ClientConnectInputs()`: 客户端连接输入
- `bool CheckTransaction() const`: 检查交易有效性
- `bool AcceptToMemoryPool(CTxDB& txdb, bool fCheckInputs, bool* pfMissingInputs)`: 接受到内存池
- `bool AcceptToMemoryPool(bool fCheckInputs, bool* pfMissingInputs)`: 接受到内存池
- `bool AddToMemoryPoolUnchecked()`: 直接添加到内存池
- `bool RemoveFromMemoryPool()`: 从内存池移除

## 6. CMerkleTx（Merkle 交易类）

CMerkleTx 继承自 CTransaction，增加了 Merkle 分支信息，用于验证交易包含在区块中。

**成员变量：**
- `uint256 hashBlock`: 包含此交易的区块哈希
- `vector<uint256> vMerkleBranch`:Merkle 分支（验证用）
- `int nIndex`: 交易在区块中的索引
- `mutable char fMerkleVerified`:Merkle 验证状态

**方法签名：**
- `CMerkleTx()`: 默认构造函数
- `CMerkleTx(const CTransaction& txIn)`: 从 CTransaction 构造
- `void Init()`: 初始化对象
- `IMPLEMENT_SERIALIZE(…)`: 序列化方法
- `int SetMerkleBranch(const CBlock* pblock)`: 设置 Merkle 分支
- `int GetDepthInMainChain(int& nHeightRet) const`: 获取主链深度
- `int GetDepthInMainChain() const`: 获取主链深度
- `bool IsInMainChain() const`: 检查是否在主链中
- `int GetBlocksToMaturity() const`: 获取成熟所需区块数
- `bool AcceptToMemoryPool(CTxDB& txdb, bool fCheckInputs)`: 接受到内存池
- `bool AcceptToMemoryPool()`: 接受到内存池

## 7. CWalletTx（钱包交易类）

CWalletTx 继承自 CMerkleTx，增加了钱包相关的元数据和管理功能。

**成员变量：**
- `vector<CMerkleTx> vtxPrev`: 前置交易列表
- `map<string, string> mapValue`: 键值对形式的额外信息
- `vector<pair<string, string>> vOrderForm`: 订单表单数据
- `unsigned int fTimeReceivedIsTxTime`: 接收时间标志
- `unsigned int nTimeReceived`: 接收到交易的时间
- `char fFromMe`: 是否由当前钱包发出
- `char fSpent`: 是否已被花费
- `string strFromAccount`: 发起账户名称
- `mutable char fDebitCached`: 支出缓存标志
- `mutable char fCreditCached`: 收入缓存标志
- `mutable char fChangeCached`: 找零缓存标志
- `mutable int64 nDebitCached`: 缓存的支出金额
- `mutable int64 nCreditCached`: 缓存的收入金额
- `mutable int64 nChangeCached`: 缓存的找零金额
- `mutable unsigned int nTimeDisplayed`: 显示时间
- `mutable int nLinesDisplayed`: 显示行数
- `mutable char fConfirmedDisplayed`: 确认状态显示标志

**方法签名：**
- `CWalletTx()`: 默认构造函数
- `CWalletTx(const CMerkleTx& txIn)`: 从 CMerkleTx 构造
- `CWalletTx(const CTransaction& txIn)`: 从 CTransaction 构造
- `void Init()`: 初始化对象
- `IMPLEMENT_SERIALIZE(…)`: 序列化方法
- `int64 GetDebit() const`: 获取支出金额
- `int64 GetCredit(bool fUseCache) const`: 获取收入金额
- `int64 GetChange() const`: 获取找零金额
- `void GetAccountAmounts(string strAccount, const set<CScript>& setPubKey, int64& nGenerated, int64& nReceived, int64& nSent, int64& nFee) const`: 获取账户金额统计
- `bool IsFromMe() const`: 检查是否由当前钱包发出
- `bool IsConfirmed() const`: 检查是否已确认
- `bool WriteToDisk()`: 写入磁盘
- `int64 GetTxTime() const`: 获取交易时间
- `int GetRequestCount() const`: 获取请求计数
- `void AddSupportingTransactions(CTxDB& txdb)`: 添加支持性交易
- `bool AcceptWalletTransaction(CTxDB& txdb, bool fCheckInputs)`: 接受钱包交易
- `bool AcceptWalletTransaction()`: 接受钱包交易
- `void RelayWalletTransaction(CTxDB& txdb)`: 中继交易到网络
- `void RelayWalletTransaction()`: 中继交易到网络

## 8. CTxIndex（交易索引类）

CTxIndex 类记录交易在磁盘上的位置及其输出被花费的情况。

**成员变量：**
- `CDiskTxPos pos`: 交易在磁盘上的位置
- `vector<CDiskTxPos> vSpent`: 花费该输出的交易位置列表

**方法签名：**
- `CTxIndex()`: 默认构造函数
- `CTxIndex(const CDiskTxPos& posIn, unsigned int nOutputs)`: 带参数构造函数
- `IMPLEMENT_SERIALIZE(…)`: 序列化方法
- `void SetNull()`: 设置为空状态
- `bool IsNull()`: 检查是否为空
- `friend bool operator==(const CTxIndex& a, const CTxIndex& b)`: 等于运算符
- `friend bool operator!=(const CTxIndex& a, const CTxIndex& b)`: 不等于运算符

## 9. CBlock（区块类）

CBlock 类是区块链的基本单元，封装了区块头和交易列表。

**成员变量：**
- `int nVersion`: 区块版本号
- `uint256 hashPrevBlock`: 前一个区块的哈希
- `uint256 hashMerkleRoot`: 交易 Merkle 树根哈希
- `unsigned int nTime`: 区块创建时间戳
- `unsigned int nBits`: 难度目标
- `unsigned int nNonce`: 工作量证明随机数
- `vector<CTransaction> vtx`: 区块包含的交易列表
- `mutable vector<uint256> vMerkleTree`:Merkle 树（仅内存）

**方法签名：**
- `CBlock()`: 默认构造函数
- `IMPLEMENT_SERIALIZE(…)`: 序列化方法
- `void SetNull()`: 设置为空状态
- `bool IsNull() const`: 检查是否为空
- `uint256 GetHash() const`: 获取区块哈希
- `int64 GetBlockTime() const`: 获取区块时间
- `int GetSigOpCount() const`: 获取签名操作数量
- `uint256 BuildMerkleTree() const`: 构建 Merkle 树
- `vector<uint256> GetMerkleBranch(int nIndex) const`: 获取 Merkle 分支
- `static uint256 CheckMerkleBranch(uint256 hash, const vector<uint256>& vMerkleBranch, int nIndex)`: 验证 Merkle 分支
- `bool WriteToDisk(unsigned int& nFileRet, unsigned int& nBlockPosRet)`: 写入磁盘
- `bool ReadFromDisk(unsigned int nFile, unsigned int nBlockPos, bool fReadTransactions)`: 从磁盘读取
- `void print() const`: 打印区块信息
- `bool DisconnectBlock(CTxDB& txdb, CBlockIndex* pindex)`: 断开区块连接
- `bool ConnectBlock(CTxDB& txdb, CBlockIndex* pindex)`: 连接区块
- `bool ReadFromDisk(const CBlockIndex* pindex, bool fReadTransactions)`: 从索引读取
- `bool SetBestChain(CTxDB& txdb, CBlockIndex* pindexNew)`: 设置最佳链
- `bool AddToBlockIndex(unsigned int nFile, unsigned int nBlockPos)`: 添加到索引
- `bool CheckBlock() const`: 检查区块有效性
- `bool AcceptBlock()`: 接受区块

## 10. CBlockIndex（区块索引类）

CBlockIndex 类维护区块链的索引结构，记录每个区块在链中的位置和状态。

**成员变量：**
- `const uint256* phashBlock`: 区块哈希指针
- `CBlockIndex* pprev`: 前一个区块索引指针
- `CBlockIndex* pnext`: 下一个区块索引指针
- `unsigned int nFile`: 区块文件编号
- `unsigned int nBlockPos`: 区块在文件中的位置
- `int nHeight`: 区块高度
- `CBigNum bnChainWork`: 链工作量
- `int nVersion`: 区块版本号
- `uint256 hashMerkleRoot`:Merkle 树根哈希
- `unsigned int nTime`: 区块时间戳
- `unsigned int nBits`: 难度目标
- `unsigned int nNonce`: 随机数

**方法签名：**
- `CBlockIndex()`: 默认构造函数
- `CBlockIndex(unsigned int nFileIn, unsigned int nBlockPosIn, CBlock& block)`: 带参数构造函数
- `CBlock GetBlockHeader() const`: 获取区块头
- `uint256 GetBlockHash() const`: 获取区块哈希
- `int64 GetBlockTime() const`: 获取区块时间
- `CBigNum GetBlockWork() const`: 获取区块工作量
- `bool IsInMainChain() const`: 检查是否在主链中
- `bool CheckIndex() const`: 检查索引有效性
- `bool EraseBlockFromDisk()`: 从磁盘删除区块
- `static const int nMedianTimeSpan`: 中位数时间跨度的区块数量
- `int64 GetMedianTimePast() const`: 获取过去区块的中位数时间
- `int64 GetMedianTime() const`: 获取当前区块的中位数时间
- `string ToString() const`: 转换为字符串
- `void print() const`: 打印输出
